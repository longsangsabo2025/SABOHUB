# üéØ TAB C√îNG VI·ªÜC - H∆Ø·ªöNG D·∫™N PH√ÅT TRI·ªÇN ƒê·∫¶Y ƒê·ª¶

## üìã T·ªïng Quan
Document n√†y h∆∞·ªõng d·∫´n ph√°t tri·ªÉn ƒë·∫ßy ƒë·ªß c√°c t√≠nh nƒÉng cho Tab C√¥ng Vi·ªác trong trang Chi Ti·∫øt C√¥ng Ty.

## ‚úÖ T√≠nh NƒÉng Hi·ªán T·∫°i
- ‚úÖ Hi·ªÉn th·ªã danh s√°ch c√¥ng vi·ªác t·ª´ database
- ‚úÖ Stats cards (T·ªïng s·ªë, C·∫ßn l√†m, ƒêang l√†m, Ho√†n th√†nh)
- ‚úÖ Task cards v·ªõi priority v√† status badges
- ‚úÖ Menu button (Edit/Delete) - **Ch∆∞a ho·∫°t ƒë·ªông**
- ‚úÖ N√∫t "Th√™m c√¥ng vi·ªác" - **Ch∆∞a ho·∫°t ƒë·ªông**
- ‚úÖ Click v√†o task card - **Ch∆∞a ho·∫°t ƒë·ªông**

## üéØ C·∫ßn Ph√°t Tri·ªÉn

### 1. Dialog T·∫°o C√¥ng Vi·ªác M·ªõi
**File:** `lib/pages/ceo/create_task_dialog.dart` (ƒë√£ t·∫°o nh∆∞ng c√≥ l·ªói)

**L·ªói c·∫ßn fix:**
```dart
// ‚ùå L·ªói: ref.read(currentUserProvider) kh√¥ng c√≥ .value ho·∫∑c .valueOrNull
final user = userAsync.valueOrNull;

// ‚úÖ C√°ch fix: Check provider implementation
final userAsync = ref.read(currentUserProvider);
// N·∫øu provider l√† AsyncValue:
final user = userAsync.when(
  data: (user) => user,
  loading: () => null,
  error: (_, __) => null,
);

// Ho·∫∑c n·∫øu provider tr·∫£ v·ªÅ User tr·ª±c ti·∫øp:
final user = ref.read(currentUserProvider);
```

**Task Model Requirements:**
```dart
Task(
  id: '', // Auto-generated by database
  branchId: '', // REQUIRED (String, kh√¥ng nullable)
  // Note: Task KH√îNG C√ì companyId field!
  title: _titleController.text.trim(),
  description: _descriptionController.text.trim(),
  category: TaskCategory.other, // D√πng 'other' kh√¥ng ph·∫£i 'general'
  priority: _selectedPriority,
  status: _selectedStatus,
  assignedTo: _selectedAssigneeId,
  assignedToName: assigneeName,
  dueDate: _selectedDueDate,
  createdBy: user.id,
  createdByName: user.name ?? user.email, // User c√≥ 'name' field
  createdAt: DateTime.now(),
  notes: '',
  // Note: KH√îNG C√ì updatedAt parameter!
)
```

**C√°c Field Quan Tr·ªçng:**
- `User.name` - NOT `User.fullName`, `User.firstName`, `User.lastName`
- `TaskCategory.other` - NOT `TaskCategory.general`
- `Task.branchId` - REQUIRED (String), kh√¥ng th·ªÉ null
- NO `Task.companyId` field
- NO `Task.updatedAt` parameter trong constructor

### 2. Dialog Ch·ªânh S·ª≠a C√¥ng Vi·ªác
**File:** `lib/pages/ceo/edit_task_dialog.dart` (ch∆∞a t·∫°o)

**Template:**
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

import '../../models/task.dart';
import '../../services/task_service.dart';
import '../../providers/task_provider.dart';

class EditTaskDialog extends ConsumerStatefulWidget {
  final Task task;
  
  const EditTaskDialog({
    super.key,
    required this.task,
  });

  @override
  ConsumerState<EditTaskDialog> createState() => _EditTaskDialogState();
}

class _EditTaskDialogState extends ConsumerState<EditTaskDialog> {
  // ... implement similar to CreateTaskDialog
  // Pre-fill with existing task data
  
  Future<void> _updateTask() async {
    final taskService = TaskService();
    await taskService.updateTask(widget.task.id, {
      'title': _titleController.text.trim(),
      'description': _descriptionController.text.trim(),
      'priority': _selectedPriority.name,
      'status': _selectedStatus.name,
      'due_date': _selectedDueDate.toIso8601String(),
      'assigned_to': _selectedAssigneeId,
      'assigned_to_name': assigneeName,
    });
    
    if (mounted) {
      Navigator.of(context).pop(true);
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('‚úÖ C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng'),
          backgroundColor: Colors.green,
        ),
      );
    }
  }
}
```

### 3. Dialog Chi Ti·∫øt C√¥ng Vi·ªác
**File:** `lib/pages/ceo/task_details_dialog.dart` (ch∆∞a t·∫°o)

**Template:**
```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

import '../../models/task.dart';

class TaskDetailsDialog extends ConsumerWidget {
  final Task task;
  
  const TaskDetailsDialog({
    super.key,
    required this.task,
  });

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final dateFormat = DateFormat('dd/MM/yyyy HH:mm');
    
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Container(
        width: 600,
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Header
            Row(
              children: [
                Icon(Icons.assignment, color: Colors.blue[700], size: 28),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    task.title,
                    style: const TextStyle(
                      fontSize: 20,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                IconButton(
                  onPressed: () => Navigator.of(context).pop(),
                  icon: const Icon(Icons.close),
                ),
              ],
            ),
            const Divider(height: 24),
            
            // Status & Priority Badges
            Row(
              children: [
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: task.priority.color.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: task.priority.color.withOpacity(0.3)),
                  ),
                  child: Text(
                    task.priority.label,
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      color: task.priority.color,
                    ),
                  ),
                ),
                const SizedBox(width: 12),
                Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                  decoration: BoxDecoration(
                    color: task.status.color.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: task.status.color.withOpacity(0.3)),
                  ),
                  child: Text(
                    task.status.label,
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      color: task.status.color,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 24),
            
            // Description
            if (task.description.isNotEmpty) ...[
              const Text(
                'M√¥ t·∫£:',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                task.description,
                style: TextStyle(fontSize: 15, color: Colors.grey[700]),
              ),
              const SizedBox(height: 24),
            ],
            
            // Details
            _buildDetailRow(
              icon: Icons.calendar_today,
              label: 'H·∫°n ho√†n th√†nh',
              value: dateFormat.format(task.dueDate),
              valueColor: task.isOverdue ? Colors.red : null,
            ),
            if (task.assignedToName != null) ...[
              const SizedBox(height: 12),
              _buildDetailRow(
                icon: Icons.person,
                label: 'Giao cho',
                value: task.assignedToName!,
              ),
            ],
            const SizedBox(height: 12),
            _buildDetailRow(
              icon: Icons.person_outline,
              label: 'Ng∆∞·ªùi t·∫°o',
              value: task.createdByName,
            ),
            const SizedBox(height: 12),
            _buildDetailRow(
              icon: Icons.access_time,
              label: 'Th·ªùi gian t·∫°o',
              value: dateFormat.format(task.createdAt),
            ),
            
            const Divider(height: 32),
            
            // Action Buttons
            Row(
              mainAxisAlignment: MainAxisAlignment.end,
              children: [
                TextButton.icon(
                  onPressed: () {
                    Navigator.of(context).pop();
                    // TODO: Show edit dialog
                  },
                  icon: const Icon(Icons.edit),
                  label: const Text('Ch·ªânh s·ª≠a'),
                ),
                const SizedBox(width: 12),
                ElevatedButton.icon(
                  onPressed: () => Navigator.of(context).pop(),
                  icon: const Icon(Icons.close),
                  label: const Text('ƒê√≥ng'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.grey[300],
                    foregroundColor: Colors.black87,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
  
  Widget _buildDetailRow({
    required IconData icon,
    required String label,
    required String value,
    Color? valueColor,
  }) {
    return Row(
      children: [
        Icon(icon, size: 20, color: Colors.grey[600]),
        const SizedBox(width: 8),
        Text(
          '$label: ',
          style: TextStyle(
            fontSize: 14,
            color: Colors.grey[600],
          ),
        ),
        Text(
          value,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.bold,
            color: valueColor ?? Colors.black87,
          ),
        ),
      ],
    );
  }
}
```

### 4. Integration v√†o CompanyDetailsPage

**File:** `lib/pages/ceo/company_details_page.dart`

**Th√™m imports:**
```dart
import 'create_task_dialog.dart';
import 'edit_task_dialog.dart';
import 'task_details_dialog.dart';
```

**Update task card click handler:**
```dart
Widget _buildTaskCard(Task task) {
  return Card(
    // ... existing card styling
    child: InkWell(
      onTap: () async {
        await showDialog(
          context: context,
          builder: (context) => TaskDetailsDialog(task: task),
        );
      },
      // ... rest of card content
    ),
  );
}
```

**Update popup menu handler:**
```dart
PopupMenuButton(
  icon: const Icon(Icons.more_vert),
  itemBuilder: (context) => [
    const PopupMenuItem(
      value: 'edit',
      child: Row(
        children: [
          Icon(Icons.edit, size: 20),
          SizedBox(width: 8),
          Text('Ch·ªânh s·ª≠a'),
        ],
      ),
    ),
    const PopupMenuItem(
      value: 'delete',
      child: Row(
        children: [
          Icon(Icons.delete, size: 20, color: Colors.red),
          SizedBox(width: 8),
          Text('X√≥a', style: TextStyle(color: Colors.red)),
        ],
      ),
    ),
  ],
  onSelected: (value) async {
    if (value == 'edit') {
      final result = await showDialog<bool>(
        context: context,
        builder: (context) => EditTaskDialog(task: task),
      );
      if (result == true) {
        ref.invalidate(companyTasksProvider(widget.companyId));
        ref.invalidate(companyTaskStatsProvider(widget.companyId));
      }
    } else if (value == 'delete') {
      final confirm = await showDialog<bool>(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('X√°c nh·∫≠n x√≥a'),
          content: Text('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng vi·ªác "${task.title}"?'),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(false),
              child: const Text('H·ªßy'),
            ),
            ElevatedButton(
              onPressed: () => Navigator.of(context).pop(true),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.red,
                foregroundColor: Colors.white,
              ),
              child: const Text('X√≥a'),
            ),
          ],
        ),
      );
      
      if (confirm == true) {
        try {
          final taskService = TaskService();
          await taskService.deleteTask(task.id);
          
          ref.invalidate(companyTasksProvider(widget.companyId));
          ref.invalidate(companyTaskStatsProvider(widget.companyId));
          
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(
                content: Text('‚úÖ X√≥a c√¥ng vi·ªác th√†nh c√¥ng'),
                backgroundColor: Colors.green,
              ),
            );
          }
        } catch (e) {
          if (mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('‚ùå L·ªói: ${e.toString()}'),
                backgroundColor: Colors.red,
              ),
            );
          }
        }
      }
    }
  },
),
```

**Update "Th√™m c√¥ng vi·ªác" button (already done):**
```dart
ElevatedButton.icon(
  onPressed: () async {
    final result = await showDialog<bool>(
      context: context,
      builder: (context) => CreateTaskDialog(
        companyId: widget.companyId,
        branchId: '', // Or get from first branch
      ),
    );
    if (result == true) {
      ref.invalidate(companyTasksProvider(widget.companyId));
      ref.invalidate(companyTaskStatsProvider(widget.companyId));
    }
  },
  icon: const Icon(Icons.add),
  label: const Text('Th√™m c√¥ng vi·ªác'),
),
```

## üîß Debug Checklist

### Khi g·∫∑p l·ªói compile:
1. ‚úÖ Check Task model fields - NO `companyId`, NO `updatedAt` trong constructor
2. ‚úÖ Check User model fields - D√πng `name` kh√¥ng ph·∫£i `fullName`
3. ‚úÖ Check TaskCategory - D√πng `TaskCategory.other` kh√¥ng ph·∫£i `.general`
4. ‚úÖ Check `branchId` - REQUIRED String, kh√¥ng th·ªÉ null
5. ‚úÖ Check currentUserProvider - C√≥ th·ªÉ l√† AsyncValue ho·∫∑c tr·∫£ v·ªÅ User tr·ª±c ti·∫øp

### Khi tasks kh√¥ng hi·ªÉn th·ªã:
1. Check `companyTasksProvider` c√≥ data kh√¥ng
2. Check trong database table `tasks` c√≥ records kh√¥ng
3. Check `company_id` field trong tasks table
4. Check RLS policies cho tasks table

### Khi t·∫°o task th·∫•t b·∫°i:
1. Check branchId c√≥ h·ª£p l·ªá kh√¥ng (ph·∫£i c√≥ branch t·ªìn t·∫°i)
2. Check user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
3. Check TaskService.createTask() method
4. Check database schema tasks table

## üìù Testing Flow

1. **Test T·∫°o Task:**
   - Click n√∫t "Th√™m c√¥ng vi·ªác"
   - Fill form ƒë·∫ßy ƒë·ªß
   - Click "T·∫°o c√¥ng vi·ªác"
   - Check task m·ªõi xu·∫•t hi·ªán trong danh s√°ch

2. **Test Xem Chi Ti·∫øt:**
   - Click v√†o m·ªôt task card
   - Dialog chi ti·∫øt hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin
   - Check c√°c badges, dates, assignee

3. **Test Ch·ªânh S·ª≠a:**
   - Click menu (3 dots) tr√™n task card
   - Ch·ªçn "Ch·ªânh s·ª≠a"
   - Modify fields
   - Save
   - Check task ƒë∆∞·ª£c update

4. **Test X√≥a:**
   - Click menu ‚Üí "X√≥a"
   - Confirm dialog xu·∫•t hi·ªán
   - Click "X√≥a"
   - Task bi·∫øn m·∫•t kh·ªèi danh s√°ch

## üöÄ Next Steps

1. Fix `create_task_dialog.dart` theo h∆∞·ªõng d·∫´n tr√™n
2. T·∫°o `edit_task_dialog.dart` v√† `task_details_dialog.dart`
3. Integrate v√†o `company_details_page.dart`
4. Test t·∫•t c·∫£ c√°c flows
5. (Optional) Th√™m features:
   - Filter tasks by status
   - Search tasks
   - Sort tasks by due date/priority
   - Bulk actions
   - Task comments/history

## üìö Resources

- Task Service: `lib/services/task_service.dart`
- Task Model: `lib/models/task.dart`
- Task Provider: `lib/providers/task_provider.dart`
- User Model: `lib/models/user.dart`
- Auth Provider: `lib/providers/auth_provider.dart`

---

**Created:** November 4, 2025
**Status:** Implementation Guide
**Priority:** HIGH - Core CEO Features
