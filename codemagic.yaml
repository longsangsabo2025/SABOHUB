# =============================================================================
# CODEMAGIC YAML CONFIGURATION - SABOHUB
# =============================================================================
# Deploy to App Store & Google Play - Hardcoded values for testing
# =============================================================================

workflows:
  ios-workflow:
    name: iOS App Store
    max_build_duration: 120
    instance_type: mac_mini_m2
    
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.sabohub.app
      flutter: stable
      xcode: latest
      cocoapods: default
      groups:
        - app_store_credentials
      vars:
        BUNDLE_ID: "com.sabohub.app"
        APP_NAME: "SABOHUB"
        # Supabase - Hardcoded
        SUPABASE_URL: "https://dqddxowyikefqcdiioyh.supabase.co"
        SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxZGR4b3d5aWtlZnFjZGlpb3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3OTcxMzYsImV4cCI6MjA3NzM3MzEzNn0.okmsG2R248fxOHUEFFl5OBuCtjtCIlO9q9yVSyCV25Y"
        SUPABASE_SERVICE_ROLE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxZGR4b3d5aWtlZnFjZGlpb3loIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTc5NzEzNiwiZXhwIjoyMDc3MzczMTM2fQ.kPmlYlVd7wi_Luzp3MHjXmR8gUqrqDHy9PSzwFDq3XI"
        # Google Drive credentials
        GOOGLE_DRIVE_CLIENT_ID_IOS: "321771498359-ocllju34h6cd4040ipoeq41j8mmg08p8.apps.googleusercontent.com"
        GOOGLE_DRIVE_CLIENT_ID_WEB: "321771498359-gcm0og29knjjmaevr7uv0aa27vam765u.apps.googleusercontent.com"
    
    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $HOME/Library/Caches/CocoaPods
    
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
    
    scripts:
      - name: Create .env file
        script: |
          echo "ðŸ“„ Creating .env file..."
          cat > .env << EOF
          SUPABASE_URL=$SUPABASE_URL
          SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
          SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY
          GOOGLE_DRIVE_CLIENT_ID_IOS=$GOOGLE_DRIVE_CLIENT_ID_IOS
          GOOGLE_DRIVE_CLIENT_ID_WEB=$GOOGLE_DRIVE_CLIENT_ID_WEB
          EOF
          echo "âœ… .env file created"
          
      - name: Clean and prepare
        script: |
          echo "ðŸ§¹ Cleaning build artifacts..."
          flutter clean
          rm -rf ios/Pods
          rm -rf ios/Podfile.lock
          rm -rf $HOME/Library/Caches/CocoaPods
          echo "âœ… Cleaned"
          
      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Auto-increment build number
        script: |
          echo "ðŸ”¢ Auto-incrementing build number..."
          CURRENT_VERSION=$(grep "^version:" pubspec.yaml | cut -d' ' -f2)
          VERSION_NAME=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
          NEW_VERSION="${VERSION_NAME}+${NEW_BUILD_NUMBER}"
          echo "ðŸ“± Updating to: $NEW_VERSION"
          sed -i.bak "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml
          grep "^version:" pubspec.yaml
        
      - name: Install CocoaPods
        script: |
          echo "â˜• Installing CocoaPods..."
          cd ios && pod install --verbose
          
      - name: Configure code signing
        script: |
          echo "ðŸ”§ Configuring code signing..."
          xcode-project use-profiles
          echo "ðŸ” Available signing identities:"
          security find-identity -v -p codesigning
          
      - name: Build iOS App
        script: |
          echo "ðŸš€ Building iOS app..."
          flutter build ios --release --verbose \
            --dart-define="SUPABASE_URL=$SUPABASE_URL" \
            --dart-define="SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" \
            --dart-define="SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY" \
            --no-codesign
          
          echo "ðŸ“¦ Creating Xcode archive..."
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/ios/archive/Runner.xcarchive \
            archive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=B465SC3K74
          echo "âœ… Archive created"
          
      - name: Export IPA
        script: |
          echo "ðŸ“¤ Exporting IPA..."
          
          # Find provisioning profile UUID
          PROFILE_UUID=""
          for profile in "$HOME/Library/MobileDevice/Provisioning Profiles"/*.mobileprovision; do
            if [ -f "$profile" ]; then
              APP_ID=$(security cms -D -i "$profile" 2>/dev/null | plutil -extract Entitlements.application-identifier raw - 2>/dev/null)
              if [[ "$APP_ID" == *"com.sabohub.app"* ]]; then
                PROFILE_UUID=$(security cms -D -i "$profile" 2>/dev/null | plutil -extract UUID raw - 2>/dev/null)
                PROFILE_NAME=$(security cms -D -i "$profile" 2>/dev/null | plutil -extract Name raw - 2>/dev/null)
                echo "âœ… Found profile: $PROFILE_NAME ($PROFILE_UUID)"
                break
              fi
            fi
          done
          
          if [ -z "$PROFILE_UUID" ]; then
            echo "âŒ No provisioning profile found!"
            exit 1
          fi
          
          # Create ExportOptions.plist
          cat > /tmp/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>B465SC3K74</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>provisioningProfiles</key>
              <dict>
                  <key>com.sabohub.app</key>
                  <string>$PROFILE_UUID</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          # Export IPA
          xcodebuild -exportArchive \
            -archivePath build/ios/archive/Runner.xcarchive \
            -exportPath build/ios/ipa \
            -exportOptionsPlist /tmp/ExportOptions.plist
          
          echo "âœ… IPA exported"
          ls -la build/ios/ipa/
          
      - name: Verify IPA
        script: |
          if ls build/ios/ipa/*.ipa 1> /dev/null 2>&1; then
            echo "âœ… IPA file found!"
            ls -la build/ios/ipa/*.ipa
          else
            echo "âŒ No IPA file found!"
            exit 1
          fi
          
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      
    publishing:
      email:
        recipients:
          - longsangsabo2025@gmail.com
        notify:
          success: true
          failure: true
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        submit_to_app_store: false

  # =========================================================================
  # ANDROID GOOGLE PLAY WORKFLOW
  # =========================================================================
  android-workflow:
    name: Android Google Play
    max_build_duration: 120
    instance_type: linux_x2
    
    environment:
      android_signing:
        - sabohub_keystore
      groups:
        - google_play
      flutter: stable
      java: 17
      vars:
        PACKAGE_NAME: "com.sabohub.app"
        SUPABASE_URL: "https://dqddxowyikefqcdiioyh.supabase.co"
        SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxZGR4b3d5aWtlZnFjZGlpb3loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3OTcxMzYsImV4cCI6MjA3NzM3MzEzNn0.okmsG2R248fxOHUEFFl5OBuCtjtCIlO9q9yVSyCV25Y"
        SUPABASE_SERVICE_ROLE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxZGR4b3d5aWtlZnFjZGlpb3loIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTc5NzEzNiwiZXhwIjoyMDc3MzczMTM2fQ.kPmlYlVd7wi_Luzp3MHjXmR8gUqrqDHy9PSzwFDq3XI"
        GOOGLE_DRIVE_CLIENT_ID_ANDROID: "321771498359-tmnp2ks7n6ipjp10fsrjrefrilr6ts15.apps.googleusercontent.com"
        GOOGLE_DRIVE_CLIENT_ID_WEB: "321771498359-gcm0og29knjjmaevr7uv0aa27vam765u.apps.googleusercontent.com"
    
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
    
    scripts:
      - name: Create .env file
        script: |
          cat > .env << EOF
          SUPABASE_URL=$SUPABASE_URL
          SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
          SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY
          GOOGLE_DRIVE_CLIENT_ID_ANDROID=$GOOGLE_DRIVE_CLIENT_ID_ANDROID
          GOOGLE_DRIVE_CLIENT_ID_WEB=$GOOGLE_DRIVE_CLIENT_ID_WEB
          EOF
          
      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Auto-increment build number
        script: |
          CURRENT_VERSION=$(grep "^version:" pubspec.yaml | cut -d' ' -f2)
          VERSION_NAME=$(echo $CURRENT_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $CURRENT_VERSION | cut -d'+' -f2)
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
          NEW_VERSION="${VERSION_NAME}+${NEW_BUILD_NUMBER}"
          sed -i.bak "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml
          echo "ðŸ“± Version: $NEW_VERSION"
          
      - name: Set up key.properties
        script: |
          cat > $CM_BUILD_DIR/android/key.properties << EOF
          storePassword=$CM_KEYSTORE_PASSWORD
          keyPassword=$CM_KEY_PASSWORD
          keyAlias=$CM_KEY_ALIAS
          storeFile=$CM_KEYSTORE_PATH
          EOF
          
      - name: Build Android App Bundle
        script: |
          flutter build appbundle --release \
            --dart-define="SUPABASE_URL=$SUPABASE_URL" \
            --dart-define="SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" \
            --dart-define="SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY"
          
    artifacts:
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/mapping.txt
      
    publishing:
      email:
        recipients:
          - longsangsabo2025@gmail.com
        notify:
          success: true
          failure: true
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: internal
        submit_as_draft: true
